<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" src="K16Assembler.js"></script>
<script type="text/javascript" src="K16Cpu.js"></script>
<script type="text/javascript" src="K16Io.js"></script>
<script type="text/javascript" src="K16Memory.js"></script>
<script type="text/javascript" src="K16Video.js"></script>

<script type="text/javascript" src="edit_area/edit_area_loader.js"></script>
<link rel="stylesheet" href="K16.css">
</head>
<body onunload="onUnload()" onload="onLoad()">
<h1>K16 CPU</h1>

<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Emulator')">Emulator</button>
  <button class="tablinks" onclick="openTab(event, 'Assembler')">Assembler</button>
  <button class="tablinks" onclick="openTab(event, 'Help')">Help</button>
  <button class="tablinks" onclick="openTab(event, 'Examples')">Examples</button>
</div>

<div id="Emulator" class="tabcontent">
<p>
  <canvas style="background-image: url('./Screen.png')" id="screen" width="739" height="588">
    Your browser does not support the canvas element.
  </canvas>
</p>
<div id="debugger" style="display:none">
<table style="width:725px">
<tr>
   <td class="verticalHeading">Registers</td>
   <td style="width: 113px; border-left: none;">
      <table id="registers" class="registers">
      <tr><td class="alignRight">R0</td><td class="alignLeft">FFFF</td></tr>
      <tr><td class="alignRight">R1</td><td class="alignLeft">123</td></tr>
      <tr><td class="alignRight">R2</td><td class="alignLeft">123</td></tr>
      <tr><td class="alignRight">R3</td><td class="alignLeft">123</td></tr>
      <tr><td class="alignRight">R4</td><td class="alignLeft">123</td></tr>
      <tr><td class="alignRight">R5</td><td class="alignLeft">123</td></tr>
      <tr><td class="alignRight">SP(R6)</td><td class="alignLeft">123</td></tr>
      <tr><td class="alignRight">PC(R7)</td><td class="alignLeft">123</td></tr>
      <tr><td class="alignRight">Flags</td><td id="FL" class="alignLeft">C,Z,N,O,I</td></tr>
      </table>
   </td>
   <td class="verticalHeading">Memory</td>
   <td style="border-left: none">
      <table id="memory" class="memory">
      <th class="alignLeft" style="width: 110px;">Base&nbsp;address&nbsp;&rarr;</th><th class="alignLeft"><input id="address1" type="text" size="4"></th><th class="alignLeft"><input id="address2" type="text" size="4"></th><th class="alignLeft"><input id="address3" type="text" size="4"></th><th class="alignLeft"><input id="address4" type="text" size="4"></th>
      <tr><td class="alignRight">+0</td><td class="alignLeft">FFFF</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td></tr>
      <tr><td class="alignRight">+1</td><td class="alignLeft">FFFF</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td></tr>
      <tr><td class="alignRight">+2</td><td class="alignLeft">FFFF</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td></tr>
      <tr><td class="alignRight">+3</td><td class="alignLeft">FFFF</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td></tr>
      <tr><td class="alignRight">+4</td><td class="alignLeft">FFFF</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td></tr>
      <tr><td class="alignRight">+5</td><td class="alignLeft">FFFF</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td></tr>
      <tr><td class="alignRight">+6</td><td class="alignLeft">FFFF</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td></tr>
      <tr><td class="alignRight">+7</td><td class="alignLeft">FFFF</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td><td class="alignLeft">0000</td></tr>
      </table>
   </td>
 </tr>
 <tr style="background-color: #FFFFFF;">
   <td class="verticalHeading">Code</td>
   <td colspan="3" style="width: 679px; border-left: none;">
      <table id="debugSource" class="debugSource">
      <th style="width: 65px">Address</th><th style="width: 35px">Code</th><th style="box-sizing: border-box; width: 100%;">Source</th>
      <tr><td class="dbgAddr">0000</td><td class="dbgInstr">1288</td><td class="dbgSrc">LD R4 R5; save register</td></tr>
      <tr><td class="dbgAddr">0000</td><td class="dbgInstr">1288</td><td class="dbgSrc">LD R4 R5; save register</td></tr>
      <tr><td class="dbgAddr">0000</td><td class="dbgInstr">1288</td><td class="dbgSrc">LD R4 R5; save register</td></tr>
      <tr><td class="dbgAddr">0000</td><td class="dbgInstr">1288</td><td class="dbgSrc">LD R4 R5; save register</td></tr>
      <tr style="font-weight: bold; background-color: #b7e8c1"><td  class="dbgAddr">0000</td><td class="dbgInstr">1288</td><td class="dbgSrc">LD R4 R5; save register</td></tr>
      <tr><td class="dbgAddr">0000</td><td class="dbgInstr">1288</td><td class="dbgSrc">LD R4 R5; save register</td></tr>
      <tr><td class="dbgAddr">0000</td><td class="dbgInstr">1288</td><td class="dbgSrc">LD R4 R5; save register</td></tr>
      <tr><td class="dbgAddr">0000</td><td class="dbgInstr">1288</td><td class="dbgSrc">LD R4 R5; save register</td></tr>
      <tr><td class="dbgAddr">0000</td><td class="dbgInstr">1288</td><td class="dbgSrc">LD R4 R5; save register</td></tr>
      </table>
   </td>
</tr>
</table>
<div class="tab" style="width:725px">
  <button class="tablinks" onclick="ioModule.setDebugSwitch(ResetC)">Reset</button>
  <button class="tablinks" onclick="ioModule.setDebugSwitch(StartC)">Start</button>
  <button class="tablinks" onclick="ioModule.setDebugSwitch(StopC);">Stop</button>
  <button class="tablinks" onclick="ioModule.setDebugSwitch(ContinueC)">Continue</button>
  <button class="tablinks" onclick="ioModule.setDebugSwitch(InstStepC)">Step</button>
  <button class="tablinks" onclick="toggleElement('debugger')" style="position: absolute; left: 625px">Close Debugger</button>
</div>
</div>
<p>
  <canvas style="background-image: url('./K16FrontPanel.png')" id="panel" width="739" height="419">
  Your browser does not support the canvas element.
  </canvas>
</p>
<p><button type="button" onclick="toggleElement('debugger')">Toggle Debugger</button></p>
</div>

<div id="Assembler" class="tabcontent">
  <p>Source code:</p>
  <textarea id="assemblyCode" rows="30" style="width: 910px"></textarea>
  <p><button type="button" onclick="assemble()">Generate Code</button>
     <button type="button" onclick="verilog()">Generate Verilog</button>
     <button type="button" onclick="upload()">Upload Code</button>
  </p>
  <p>Generated code:</p>
  <textarea readonly class="code" id="generatedCode" rows="30" style="width: 910px"></textarea>
</div>
<div id="Help" class="tabcontent" w3-include-html="./K16InstructionSet.html"></div>

<div id="Examples" class="tabcontent" w3-include-html="./K16ExampleCode.html"></div>

<script>


function onUnload()
{
   localStorage.setItem("K16-Current", editAreaLoader.getValue("assemblyCode"));
}

function onLoad()
{
   if ("K16-Current" in localStorage)
   {
      var code = localStorage.getItem("K16-Current");
      editAreaLoader.setValue("assemblyCode", code);
   }
}

function includeHTML() 
{
   var z, i, elmnt, file, xhttp;
   
   // Loop through a collection of all HTML elements:
   z = document.getElementsByTagName("*");
   for (i = 0; i < z.length; i++)
   {
      elmnt = z[i];
      // Search for elements with a certain atrribute:
      file = elmnt.getAttribute("w3-include-html");
      if (file) 
      {
         // Make an HTTP request using the attribute value as the file name:
         xhttp = new XMLHttpRequest();
         xhttp.onreadystatechange = function() 
         {
            if (this.readyState == 4) 
            {
               if (this.status == 200) 
               {
                  elmnt.innerHTML = this.responseText;
               }
               if (this.status == 404)
               {
                  elmnt.innerHTML = "Page not found.";
               }
               // Remove the attribute, and call this function once more:
               elmnt.removeAttribute("w3-include-html");
               includeHTML();
            }
         }      
         xhttp.open("GET", file, true);
         xhttp.setRequestHeader('Cache-Control', 'no-cache');
         xhttp.send();
         // Exit the function:
         return;
      }
   }
};

function openTab(evt, tabName) 
{
   var i, tabcontent, tablinks;
   tabcontent = document.getElementsByClassName("tabcontent");
   for (i = 0; i < tabcontent.length; i++) 
   {
      tabcontent[i].style.display = "none";
   }
   tablinks = document.getElementsByClassName("tablinks");
   for (i = 0; i < tablinks.length; i++) 
   {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
   }
   document.getElementById(tabName).style.display = "block";
   evt.currentTarget.className += " active";
   if (tabName == "Assembler")
   {
      editAreaLoader.init(
      {
         id: "assemblyCode",	// id of the textarea to transform		
         start_highlight: true,	// if start with highlight
         font_size: 12,
         allow_resize: "both",
         allow_toggle: true,
         word_wrap: false,
         language: "en",
         syntax: "k16",
         replace_tab_by_spaces: 3,
         toolbar: "new_document, load, save, | ,search, go_to_line, |, undo, redo, |, select_font, |, change_smooth_selection, highlight, reset_highlight, |, help",
         load_callback: "loadCode",
         save_callback: "saveCode"
      });
   }
}

function toggleElement(theElement)
{
   var x = document.getElementById(theElement);
   if (x)
   {
      if (x.style.display == "none")
      {
         x.style.display = "block";
      }
      else
      {
         x.style.display = "none";
      }
   }
}

function copyCode(theId) 
{
   // Get the text field 
   var copyText = document.getElementById(theId);
   editAreaLoader.setValue("assemblyCode", copyText.value);
   document.getElementById("Examples").style.display = "none";
   document.getElementById("Assembler").style.display = "block";
   editAreaLoader.init(
   {
      id: "assemblyCode",	// id of the textarea to transform		
      start_highlight: true,	// if start with highlight
      font_size: 12,
      allow_resize: "both",
      allow_toggle: true,
      word_wrap: false,
      language: "en",
      syntax: "k16",
      replace_tab_by_spaces: 3,
      toolbar: "new_document, load, save, | ,search, go_to_line, |, undo, redo, |, select_font, |, change_smooth_selection, highlight, reset_highlight, |, help",
      load_callback: "loadCode",
      save_callback: "saveCode"
   });
   tablinks = document.getElementsByClassName("tablinks");
   for (var i = 0; i < tablinks.length; i++) 
   {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
   }
   for (var i = 0; i < tablinks.length; i++) 
   {
      var htm = tablinks[i].innerHTML;
      if (htm == "Assembler")
      {
         tablinks[i].className += " active";
         break;
      }
   }
}

function getFileList()
{
   var fileList = "";
   for (var name in localStorage )
   {
      if (name.startsWith("K16-"))
      {
         fileList += "\"" + name.substr(4) + "\"\n";
      }
   }
   return fileList;
}

function loadCode(theEditorWindow)
{
   if (typeof(Storage) == "undefined") 
   {
      alert("Sorry, your browser does not support Web Storage...");
   }

   // Load
   var fileList = getFileList();
   if (fileList.length == 0)
   {
      alert("ERROR: You have not saved any files");
      return;
   }
   var filename = "";
   if ("K16PreviousFilename" in localStorage)
   {
      filename = localStorage.getItem("K16PreviousFilename");
   }
   
   filename = prompt(fileList + "\nEnter filename", filename);  
   if (filename == null)
   {
      return;
   }
   
   filename = filename.trim();
   if (filename. length == 0)
   {
      alert("ERROR: Empty filename");
      return;
   }
   
   var code = localStorage.getItem("K16-" + filename);
   localStorage.setItem("K16PreviousFilename", filename);
   if (code == null)
   {
      alert("ERROR: File \"" + filename + "\" does not exist.");
      return;
   }

   editAreaLoader.setValue("assemblyCode", code);
}

function saveCode(theEditorWindow, theCode)
{
   if (typeof(Storage) == "undefined") 
   {
      alert("Sorry, your browser does not support Web Storage...");
   }

   // Save
   var filename = "";
   if ("K16PreviousFilename" in localStorage)
   {
      filename = localStorage.getItem("K16PreviousFilename");
   }
   if (theCode.length > 0)
   {
      filename = prompt("Save file:\nEnter filename", filename);
   }
   else
   {
      var fileList = getFileList();
      if (fileList.length == 0)
      {
         alert("ERROR: There are no files to remove.");
         return;
      }
      filename = prompt(fileList + "Remove file:\nEnter filename", filename);
   }
      
   if (filename == null)
   {
      return;
   }
   filename = filename.trim();
   if (filename.length == 0)
   {
      alert("ERROR: Empty filename.");
   }
   if (theCode.length > 0)
   {
      if ("K16-" + filename in localStorage)
      {
         if (confirm("File \"" + filename + "\"exists already.\nDo you want to overwrite it?") == false)
         {
            return;
         }
      }
      localStorage.setItem("K16-" + filename, theCode);
      localStorage.setItem("K16PreviousFilename", filename);
      alert("File \"" + filename + "\" stored!");
   }
   else
   {
      if ("K16-" + filename in localStorage)
      {
         if (confirm("Do you want you remove file \"" + filename + "\"?") == false)
         {
            return;
         }
         localStorage.removeItem("K16-" + filename);
         alert("File \"" + filename + "\" removed!");
      }
      else
      {
         alert("ERROR: File \"" + filename + "\" does not exist.");
      }
   }
}

// Close the dropdown if the user clicks outside of it
window.onclick = function(event) {
  if (!event.target.matches('.dropbtn')) {
    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}

var ioModule = new K16Io();
var screen = new K16Video();
var memory = new K16Memory(screen.frameBuffer, ioModule);
var cpu = new K16Cpu(memory);

var assembler = new K16Assembler();

includeHTML();

// ----------------------------------------------------------------------------

function mouseDown(event)
{
   ioModule.setSwitches();
}

// ----------------------------------------------------------------------------

function assemble()
{
   var assemblyCode = editAreaLoader.getValue("assemblyCode");
   
   assembler = new K16Assembler();
   
   if (assembler.parse(assemblyCode) == false)
   {
      var errorMessage = "Error in line " + assembler.line + ": " + assembler.errorMessage;
      editAreaLoader.setValue("generatedCode", errorMessage);
      document.getElementById("generatedCode").value = errorMessage;
      return undefined
   }
   else
   {
      var output = "";
      for (var i = 1; i < assembler.sourceCode.length; i++)
      {
         var line = assembler.sourceCode[i];
         if (line)
         {
            if (line.address != undefined)
            {
               output += line.address.toString(16).padStart(4, "0") + " ";
               output += assembler.code[line.address].toString(16).padStart(4, "0") + " ";
               output += line.sourceCode;
               for (var j = 1; j < line.length; j++)
               {
                  output += (line.address + j).toString(16).padStart(4, "0") + " ";
                  output += assembler.code[line.address + j].toString(16).padStart(4, "0") + "\n";         
               }
            }
            else
            {
               output += "          " + line.sourceCode;
            }
         }
      }
      editAreaLoader.setValue("generatedCode", output);
      document.getElementById("generatedCode").value = output;
      return assembler;
   }
}

// ----------------------------------------------------------------------------

function upload()
{
   var assembler = assemble();
   if (assembler != undefined)
   {
      for (var address in assembler.code)
      {
         memory.setAddress(address);
         memory.write(assembler.code[address]);
      }
   }
   document.getElementById("Assembler").style.display = "none";
   document.getElementById("Emulator").style.display = "block";
   tablinks = document.getElementsByClassName("tablinks");
   for (var i = 0; i < tablinks.length; i++) 
   {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
   }
   for (var i = 0; i < tablinks.length; i++) 
   {
      var htm = tablinks[i].innerHTML;
      if (htm == "Emulator")
      {
         tablinks[i].className += " active";
         break;
      }
   }
}

// ----------------------------------------------------------------------------

function verilog()
{
   var assemblyCode = editAreaLoader.getValue("assemblyCode");
   
   assembler = new K16Assembler();
   
   if (assembler.parse(assemblyCode) == false)
   {
      var errorMessage = "Error in line " + assembler.line + ": " + assembler.errorMessage;
      editAreaLoader.setValue("generatedCode", errorMessage);
      document.getElementById("generatedCode").value = errorMessage;
      return undefined
   }
   else
   {
      var output = "";
      for (var i = 1; i < assembler.sourceCode.length; i++)
      {
         var line = assembler.sourceCode[i];
         if (line)
         {
            if (line.address != undefined)
            {
               output += "mem[" + line.address + "] = 16'h";
               output += assembler.code[line.address].toString(16).padStart(4, "0") + "; // ";
               output += line.sourceCode;
               for (var j = 1; j < line.length; j++)
               {
                  output += "mem[" + (line.address + j) + "] = 16'h";
                  output += assembler.code[line.address + j].toString(16).padStart(4, "0") + ";\n";         
               }
            }
            else
            {
               output += "                   // " + line.sourceCode;
            }
         }
      }
      editAreaLoader.setValue("generatedCode", output);
      document.getElementById("generatedCode").value = output;
      return assembler;
   }
}

// ----------------------------------------------------------------------------

function displayMemory(theElement, theMemory, theCpu, theAddress)
{
   var newValue = theMemory.inspect(theAddress & 0xFFFF);
   if (newValue != undefined)
   {
      newValue = newValue.toString(16).padStart(4, "0").toUpperCase();
      if (theAddress == theCpu.regM[6])
      {
         theElement.innerHTML = newValue + " &lt;SP";
      }
      else
      {
         theElement.innerHTML = newValue;
      }
   }
   else
   {
      theElement.innerHTML = "----";
   }
}
// ----------------------------------------------------------------------------

function displayState(theCpu, theMemory, theAssembler)
{
   var registers = document.getElementById("registers");
   for (var i = 0; i < 8; i++)
   {
      var element = registers.rows[i].cells[1];
      var newValue = theCpu.regM[i].toString(16).padStart(4, "0").toUpperCase();
      element.innerHTML = newValue;
   }
   
   var flags = "";
   
   if (theCpu.flagsM.carry == 1)
   {
      flags += "C";
   }
   if (theCpu.flagsM.zero == 1)
   {
      flags += "Z";
   }
   if (theCpu.flagsM.negative == 1)
   {
      flags += "N";
   }
   if (theCpu.flagsM.overflow == 1)
   {
      flags += "O";
   }
   if (theCpu.flagsM.enableInterupt == 1)
   {
      flags += "I";
   }
   
   document.getElementById("FL").innerHTML = flags;
   var address1 = parseInt(document.getElementById("address1").value, 16);
   if (isNaN(address1))
   {
      address1 = 0;
   }   
   var address2 = parseInt(document.getElementById("address2").value, 16);
   if (isNaN(address2))
   {
      address2 = address1 + 8;
   }
   var address3 = parseInt(document.getElementById("address3").value, 16);
   if (isNaN(address3))
   {
      address3 = address2 + 8;
   }
   var address4 = parseInt(document.getElementById("address4").value, 16);
   if (isNaN(address4))
   {
      address4 = address3 + 8;
   }
   var memory = document.getElementById("memory");
   for (var i = 0; i < 8; i++)
   {
      var element = memory.rows[i + 1].cells[1];
      displayMemory(element, theMemory, theCpu, i + address1);
      element = memory.rows[i + 1].cells[2];
      displayMemory(element, theMemory, theCpu, i + address2);
      element = memory.rows[i + 1].cells[3];
      displayMemory(element, theMemory, theCpu, i + address3);
      element = memory.rows[i + 1].cells[4];
      displayMemory(element, theMemory, theCpu, i + address4);
   }   
   var debuggerSource = document.getElementById("debugSource");
   var pc = theCpu.regM[7];
   for (var i = 0; i < 9; i++)
   {
      var row = debuggerSource.rows[i + 1];
      var address = pc + i - 4;
      if (address >= 0 && address <= 0xFFFF)
      {
         if (address == pc)
         {
            row.cells[0].innerHTML = address.toString(16).padStart(4, "0").toUpperCase() + " &lt;PC";
         }
         else
         {
            row.cells[0].innerHTML = address.toString(16).padStart(4, "0").toUpperCase();
         }
         var instruction = theMemory.memoryM[pc + i - 4];
         if (instruction != undefined)
         {
            row.cells[1].innerHTML = instruction.toString(16).padStart(4, "0").toUpperCase();
         }
         var sourceCode = theAssembler.getSourceAtAddress(address);
         if (sourceCode != undefined)
         {
            row.cells[2].innerHTML = "<span class=\"debugSource\">" + sourceCode + "</span>";
         }
         else
         {
            row.cells[2].innerHTML = "?";
         }
      }
      else
      {
         row.cells[0].innerHTML = "----";
         row.cells[1].innerHTML = "----";
         row.cells[2].innerHTML = "";
      }
   }   
}

// ----------------------------------------------------------------------------

var panelCanvas = document.getElementById("panel");
var panelCtx = panelCanvas.getContext("2d");

var screenCanvas = document.getElementById("screen");
var screenCtx = screenCanvas.getContext("2d");

panelCanvas.addEventListener("mousedown", mouseDown, false);

ioModule.draw();

window.requestAnimationFrame(mainLoop);

var previousTime;

document.getElementById("Emulator").style.display = "block";
   tablinks = document.getElementsByClassName("tablinks");
   for (var i = 0; i < tablinks.length; i++) 
   {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
   }
   for (var i = 0; i < tablinks.length; i++) 
   {
      var htm = tablinks[i].innerHTML;
      if (htm == "Emulator")
      {
         tablinks[i].className += " active";
         break;
      }
   }

function mainLoop(theTimestamp)
{
   if (previousTime)
   {
      var deltaTime = theTimestamp - previousTime;
      if (deltaTime > 200)
      {
         deltaTime = 200;
      }
      
      ioModule.checkCtrlSwitches(theTimestamp);
      
      for (var i = 0; i < deltaTime * 1000; i++)
      {
         ioModule.clockTick();
         
         if (ioModule.resetPushed())
         {
            cpu.reset();
         }
         else
         if (ioModule.stopPushed())
         {
            cpu.stop();
         }
         cpu.clockTick();
      }
   }
   previousTime = theTimestamp;

   ioModule.running = cpu.runningM;
   ioModule.draw();   
   screen.draw(screenCtx, 48, 48);
   
   if (cpu.runningM == false)
   {
      displayState(cpu, memory, assembler);
   }

   window.requestAnimationFrame(mainLoop);
}
</script>
</body>
</html> 
