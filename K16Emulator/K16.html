<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" src="K16Assembler.js"></script>
<script type="text/javascript" src="K16Cpu.js"></script>
<script type="text/javascript" src="K16Io.js"></script>
<script type="text/javascript" src="K16Memory.js"></script>
<script type="text/javascript" src="K16Video.js"></script>

<script type="text/javascript" src="edit_area/edit_area_loader.js"></script>
<link rel="stylesheet" href="K16.css">
</head>
<body>
<h1>K16 CPU</h1>

<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Emulator')">Emulator</button>
  <button class="tablinks" onclick="openTab(event, 'Assembler')">Assembler</button>
  <button class="tablinks" onclick="openTab(event, 'Help')">Help</button>
  <button class="tablinks" onclick="openTab(event, 'Examples')">Examples</button>
</div>

<div id="Emulator" class="tabcontent">
<p>
  <canvas style="background-image: url('./Screen.png')" id="screen" width="739" height="588">
    Your browser does not support the canvas element.
  </canvas>
</p>
<p>
  <canvas style="background-image: url('./K16FrontPanel.png')" id="panel" width="739" height="419">
  Your browser does not support the canvas element.
  </canvas>
</p>
</div>

<div id="Assembler" class="tabcontent">
  <p>Source code:</p>
  <textarea id="assemblyCode" rows="30" style="width: 910px"></textarea>
  <p><button type="button" onclick="assemble()">Generate Code</button>
     <button type="button" onclick="verilog()">Generate Verilog</button>
     <button type="button" onclick="upload()">Upload Code</button>
  </p>
  <p>Generated code:</p>
  <textarea readonly class="code" id="generatedCode" rows="30" style="width: 910px"></textarea>
</div>


<div id="Help" class="tabcontent" w3-include-html="./K16InstructionSet.html"></div>

<div id="Examples" class="tabcontent" w3-include-html="./K16ExampleCode.html"></div>

<script>
function includeHTML() 
{
   var z, i, elmnt, file, xhttp;
   
   // Loop through a collection of all HTML elements:
   z = document.getElementsByTagName("*");
   for (i = 0; i < z.length; i++)
   {
      elmnt = z[i];
      // Search for elements with a certain atrribute:
      file = elmnt.getAttribute("w3-include-html");
      if (file) 
      {
         // Make an HTTP request using the attribute value as the file name:
         xhttp = new XMLHttpRequest();
         xhttp.onreadystatechange = function() 
         {
            if (this.readyState == 4) 
            {
               if (this.status == 200) 
               {
                  elmnt.innerHTML = this.responseText;
               }
               if (this.status == 404)
               {
                  elmnt.innerHTML = "Page not found.";
               }
               // Remove the attribute, and call this function once more:
               elmnt.removeAttribute("w3-include-html");
               includeHTML();
            }
         }      
         xhttp.open("GET", file, true);
         xhttp.setRequestHeader('Cache-Control', 'no-cache');
         xhttp.send();
         // Exit the function:
         return;
      }
   }
};

function openTab(evt, tabName) 
{
   var i, tabcontent, tablinks;
   tabcontent = document.getElementsByClassName("tabcontent");
   for (i = 0; i < tabcontent.length; i++) 
   {
      tabcontent[i].style.display = "none";
   }
   tablinks = document.getElementsByClassName("tablinks");
   for (i = 0; i < tablinks.length; i++) 
   {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
   }
   document.getElementById(tabName).style.display = "block";
   evt.currentTarget.className += " active";
   if (tabName == "Assembler")
   {
      editAreaLoader.init(
      {
         id: "assemblyCode",	// id of the textarea to transform		
         start_highlight: true,	// if start with highlight
         font_size: 12,
         allow_resize: "both",
         allow_toggle: false,
         word_wrap: false,
         language: "en",
         syntax: "k16",
         replace_tab_by_spaces: 3,
         toolbar: "new_document, load, save, | ,search, go_to_line, |, undo, redo, |, select_font, |, change_smooth_selection, highlight, reset_highlight, |, help",
         load_callback: "loadCode",
         save_callback: "saveCode"
      });
   }
}

function copyCode(theId) 
{
   // Get the text field 
   var copyText = document.getElementById(theId);
   editAreaLoader.setValue("assemblyCode", copyText.value);
}

function loadCode(theEditorWindow)
{
   if (typeof(Storage) !== "undefined") 
   {
      // Load
      var code = localStorage.getItem("lastname");
      editAreaLoader.setValue("assemblyCode", code);
   } 
   else 
   {
      alert("Sorry, your browser does not support Web Storage...");
   }
}

function saveCode(theEditorWindow, theCode)
{
   if (typeof(Storage) !== "undefined") 
   {
      // Save
      localStorage.setItem("lastname", theCode);
   } 
   else 
   {
      alert("Sorry, your browser does not support Web Storage...");
   }
}

</script>
<script>

var ioModule = new K16Io();
var screen = new K16Video();
var memory = new K16Memory(screen.frameBuffer, ioModule);
var cpu = new K16Cpu(memory);

includeHTML();

// ----------------------------------------------------------------------------

function mouseDown(event)
{
   ioModule.setSwitches();
}

// ----------------------------------------------------------------------------

function assemble()
{
   var assemblyCode = editAreaLoader.getValue("assemblyCode");
   
   var assembler = new K16Assembler();
   
   if (assembler.parse(assemblyCode) == false)
   {
      var errorMessage = "Error in line " + assembler.line + ": " + assembler.errorMessage;
      editAreaLoader.setValue("generatedCode", errorMessage);
      document.getElementById("generatedCode").value = errorMessage;
      return undefined
   }
   else
   {
      var output = "";
      for (var i = 1; i < assembler.sourceCode.length; i++)
      {
         var line = assembler.sourceCode[i];
         if (line.address != undefined)
         {
            output += line.address.toString(16).padStart(4, "0") + " ";
            output += assembler.code[line.address].toString(16).padStart(4, "0") + " ";
            output += line.sourceCode;
            for (var j = 1; j < line.length; j++)
            {
               output += (line.address + j).toString(16).padStart(4, "0") + " ";
               output += assembler.code[line.address + j].toString(16).padStart(4, "0") + "\n";         
            }
         }
         else
         {
            output += "          " + line.sourceCode;
         }
      }
      editAreaLoader.setValue("generatedCode", output);
      document.getElementById("generatedCode").value = output;
      return assembler;
   }
}

// ----------------------------------------------------------------------------

function upload()
{
   var assembler = assemble();
   if (assembler != undefined)
   {
      for (var address in assembler.code)
      {
         memory.setAddress(address);
         memory.write(assembler.code[address]);
      }
   }
}

// ----------------------------------------------------------------------------

function verilog()
{
   var assemblyCode = editAreaLoader.getValue("assemblyCode");
   
   var assembler = new K16Assembler();
   
   if (assembler.parse(assemblyCode) == false)
   {
      var errorMessage = "Error in line " + assembler.line + ": " + assembler.errorMessage;
      editAreaLoader.setValue("generatedCode", errorMessage);
      document.getElementById("generatedCode").value = errorMessage;
      return undefined
   }
   else
   {
      var output = "";
      for (var i = 1; i < assembler.sourceCode.length; i++)
      {
         var line = assembler.sourceCode[i];
         if (line.address != undefined)
         {
            output += "mem[" + line.address + "] = 16'h";
            output += assembler.code[line.address].toString(16).padStart(4, "0") + "; // ";
            output += line.sourceCode;
            for (var j = 1; j < line.length; j++)
            {
               output += "mem[" + (line.address + j) + "] = 16'h";
               output += assembler.code[line.address + j].toString(16).padStart(4, "0") + ";\n";         
            }
         }
         else
         {
            output += "                   // " + line.sourceCode;
         }
      }
      editAreaLoader.setValue("generatedCode", output);
      document.getElementById("generatedCode").value = output;
      return assembler;
   }
}

var panelCanvas = document.getElementById("panel");
var panelCtx = panelCanvas.getContext("2d");

var screenCanvas = document.getElementById("screen");
var screenCtx = screenCanvas.getContext("2d");

panelCanvas.addEventListener("mousedown", mouseDown, false);

ioModule.draw();

window.requestAnimationFrame(mainLoop);

var previousTime;

document.getElementById("Emulator").style.display = "block";

function mainLoop(theTimestamp)
{
   if (previousTime)
   {
      var deltaTime = theTimestamp - previousTime;
      if (deltaTime > 200)
      {
         deltaTime = 200;
      }
      
      ioModule.checkCtrlSwitches(theTimestamp);
      
      for (var i = 0; i < deltaTime * 1000; i++)
      {
         ioModule.clockTick();
         
         if (ioModule.resetPushed())
         {
            cpu.reset();
         }
         else
         if (ioModule.stopPushed())
         {
            cpu.stop();
         }
         cpu.clockTick();
      }
   }
   previousTime = theTimestamp;

   ioModule.running = cpu.runningM;
   ioModule.draw();   
   screen.draw(screenCtx, 48, 48);
   window.requestAnimationFrame(mainLoop);
}


</script>


<script>
</script>
   
</body>
</html> 
